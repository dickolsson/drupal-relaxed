services:
  # Index Factory
  relaxed.entity_index.factory:
    class: Drupal\relaxed\Entity\Index\IndexFactory
    arguments: ['@service_container', '@workspace.manager']

  # Index children
  relaxed.entity_index.id.scope:
    parent: relaxed.entity_index.id
    scope: prototype
  relaxed.entity_index.uuid.scope:
    parent: relaxed.entity_index.uuid
    scope: prototype
  relaxed.entity_index.rev.scope:
    parent: relaxed.entity_index.rev
    scope: prototype

  # Indexes
  relaxed.entity_index.id:
    class: Drupal\relaxed\Entity\Index\EntityIndex
    arguments: ['@keyvalue', '@workspace.manager']
  relaxed.entity_index.uuid:
    class: Drupal\relaxed\Entity\Index\UuidIndex
    arguments: ['@keyvalue', '@workspace.manager']
  relaxed.entity_index.rev:
    class: Drupal\relaxed\Entity\Index\RevisionIndex
    arguments: ['@keyvalue', '@workspace.manager']
    
  paramconverter.docid:
    class: Drupal\relaxed\ParamConverter\DocIdConverter
    arguments: ['@entity.manager', '@relaxed.entity_index.uuid', '@relaxed.entity_index.rev']
    tags:
      - { name: paramconverter, priority: 30 }
  paramconverter.db:
    class: Drupal\relaxed\ParamConverter\DbConverter
    arguments: ['@workspace.manager']
    tags:
      - { name: paramconverter, priority: 20 }
  paramconverter.entity_uuid:
    class: Drupal\relaxed\ParamConverter\EntityUuidConverter
    arguments: ['@entity.manager', '@relaxed.entity_index.uuid']
    tags:
      - { name: paramconverter, priority: 20 }
  workspace.negotiator.relaxed:
    class: Drupal\relaxed\Workspace\RelaxedWorkspaceNegotiator
    arguments: ['@config.factory']
    calls:
      - [setContainer, ['@service_container']]
      - [setCurrentUser, ['@current_user']]
      - [setWorkspaceManager, ['@workspace.manager']]
    tags:
      - { name: workspace_negotiator, priority: 300 }
  plugin.manager.format_negotiator:
    class: Drupal\relaxed\Plugin\FormatNegotiatorManager
    parent: default_plugin_manager
  plugin.manager.remote_check:
    class: Drupal\relaxed\Plugin\RemoteCheckManager
    parent: default_plugin_manager
  relaxed.remote_pointer:
    class: Drupal\relaxed\RemotePointer
    arguments: ['@entity_type.manager', '@http_client']
  relaxed.couchdb_replicator:
    class: Drupal\relaxed\CouchdbReplicator
    arguments: ['@config.factory', '@relaxed.sensitive_data.transformer']
    tags:
      - {name: workspace_replicator, priority: 20}
  relaxed.replicate:
    class: Drupal\relaxed\Replicate\Replicate
  relaxed.normalizer.replicate:
    class: Drupal\relaxed\Normalizer\ReplicateNormalizer
    tags:
      - { name: normalizer, priority: 10 }
    arguments: ['@relaxed.replicate']
  relaxed.resource_response.subscriber:
    class: Drupal\relaxed\EventSubscriber\ResourceResponseSubscriber
    tags:
      - { name: event_subscriber }
    arguments: ['@serializer', '@renderer', '@current_route_match']
  relaxed.process_file_attachment:
    class: Drupal\relaxed\ProcessFileAttachment
    arguments: ['@current_user', '@entity_type.manager', '@relaxed.entity_index.factory']
  relaxed.users_mapping:
    class: Drupal\relaxed\UsersMapping
    arguments: ['@config.factory', '@entity_type.manager']

#Normalizers
  relaxed.normalizer.link_item:
    class: Drupal\relaxed\Normalizer\LinkItemNormalizer
    arguments: ['@entity_type.manager', '@relaxed.entity_index.factory']
    tags:
      - { name: normalizer, priority: 5 }
  relaxed.normalizer.text_item:
    class: Drupal\relaxed\Normalizer\TextItemNormalizer
    tags:
      - { name: normalizer, priority: 5 }
  relaxed.normalizer.content_entity:
    class: Drupal\relaxed\Normalizer\ContentEntityNormalizer
    arguments: ['@entity.manager', '@relaxed.entity_index.factory', '@language_manager', '@relaxed.process_file_attachment', '@relaxed.users_mapping', '@plugin.manager.entity_reference_selection']
    tags:
      - { name: normalizer, priority: 10 }
  relaxed.normalizer.replication_log:
    class: Drupal\relaxed\Normalizer\ReplicationLogNormalizer
    arguments: ['@entity_type.manager', '@relaxed.entity_index.uuid']
    tags:
      - { name: normalizer, priority: 20 }
  relaxed.normalizer.bulk_docs:
    class: Drupal\relaxed\Normalizer\BulkDocsNormalizer
    tags:
      - { name: normalizer, priority: 20 }
  relaxed.normalizer.all_docs:
    class: Drupal\relaxed\Normalizer\AllDocsNormalizer
    arguments: ['@entity.manager', '@relaxed.entity_index.uuid']
    tags:
      - { name: normalizer, priority: 10 }
  relaxed.normalizer.changes:
    class: Drupal\relaxed\Normalizer\ChangesNormalizer
    tags:
      - { name: normalizer }
  relaxed.normalizer.workspace:
    class: Drupal\relaxed\Normalizer\WorkspaceNormalizer
    tags:
      - { name: normalizer, priority: 20 }
    arguments: ['@entity.manager']
  relaxed.normalizer.deleted_flag_item_list:
    class: Drupal\relaxed\Normalizer\DeletedFlagItemListNormalizer
    tags:
      - { name: normalizer, priority: 10 }
  relaxed.normalizer.revision_info_item_list:
    class: Drupal\relaxed\Normalizer\RevisionInfoItemListNormalizer
    tags:
      - { name: normalizer, priority: 10 }
  relaxed.normalizer.revs_diff:
    class: Drupal\relaxed\Normalizer\RevsDiffNormalizer
    arguments: []
    tags:
      - { name: normalizer, priority: 30 }
  relaxed.normalizer.attachment:
    class: Drupal\relaxed\Normalizer\AttachmentNormalizer
    arguments: ['@entity.manager', '@relaxed.entity_index.factory', '@language_manager', '@relaxed.process_file_attachment', '@relaxed.users_mapping', '@plugin.manager.entity_reference_selection']
    tags:
      - { name: normalizer, priority: 30 }
  relaxed.normalizer.file_item:
    class: Drupal\relaxed\Normalizer\FileItemNormalizer
    tags:
      - { name: normalizer, priority: 10 }
  relaxed.normalizer.entity_reference_item:
    class: Drupal\relaxed\Normalizer\EntityReferenceItemNormalizer
    tags:
      - { name: normalizer, priority: 10 }
  relaxed.normalizer.comment_item:
    class: Drupal\relaxed\Normalizer\CommentItemNormalizer
    tags:
      - { name: normalizer, priority: 10 }
