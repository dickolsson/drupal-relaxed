services:
  # Index Factory
  relaxed.entity_index.factory:
    class: Drupal\relaxed\Entity\Index\IndexFactory
    arguments: ['@service_container', '@workspaces.manager']

  # Index children
  relaxed.entity_index.id.scope:
    parent: relaxed.entity_index.id
    scope: prototype
  relaxed.entity_index.uuid.scope:
    parent: relaxed.entity_index.uuid
    scope: prototype
  relaxed.entity_index.rev.scope:
    parent: relaxed.entity_index.rev
    scope: prototype

  # Indexes
  relaxed.entity_index.id:
    class: Drupal\relaxed\Entity\Index\EntityIndex
    arguments: ['@keyvalue', '@workspaces.manager']
  relaxed.entity_index.uuid:
    class: Drupal\relaxed\Entity\Index\UuidIndex
    arguments: ['@keyvalue', '@workspaces.manager']
  relaxed.entity_index.rev:
    class: Drupal\relaxed\Entity\Index\RevisionIndex
    arguments: ['@keyvalue', '@workspaces.manager']

  logger.channel.relaxed:
    parent: logger.channel_base
    arguments: ['relaxed']
# Param converters
  paramconverter.docid:
    class: Drupal\relaxed\ParamConverter\DocIdConverter
    arguments: ['@entity.manager', '@multiversion.entity_index.uuid', '@multiversion.entity_index.rev', '@multiversion.entity_index.rev.tree']
    tags:
      - { name: paramconverter, priority: 30 }
  paramconverter.db:
    class: Drupal\relaxed\ParamConverter\DbConverter
    arguments: ['@workspaces.manager']
    tags:
      - { name: paramconverter, priority: 20 }
  paramconverter.entity_uuid:
    class: Drupal\relaxed\ParamConverter\EntityUuidConverter
    arguments: ['@entity.manager', '@multiversion.entity_index.uuid']
    tags:
      - { name: paramconverter, priority: 20 }

  relaxed.workspace.negotiator:
    class: Drupal\relaxed\Workspace\RelaxedWorkspaceNegotiator
    arguments: ['@workspaces.manager', '@config.factory']
    tags:
      - { name: workspace_negotiator, priority: 300 }

# Plugin
  plugin.manager.api_resource:
    class: Drupal\relaxed\Plugin\ApiResourceManager
    parent: default_plugin_manager
  plugin.manager.format_negotiator:
    class: Drupal\relaxed\Plugin\FormatNegotiatorManager
    parent: default_plugin_manager
  plugin.manager.remote_check:
    class: Drupal\relaxed\Plugin\RemoteCheckManager
    parent: default_plugin_manager

  relaxed.remote_pointer:
    class: Drupal\relaxed\RemotePointer
    arguments: ['@entity_type.manager', '@http_client']
  relaxed.couchdb_replicator:
    class: Drupal\relaxed\CouchdbReplicator
    arguments: ['@config.factory', '@relaxed.sensitive_data.transformer']
    tags:
      - {name: workspace_replicator, priority: 20}
  relaxed.replicate:
    class: Drupal\relaxed\Replicate\Replicate

  relaxed.normalizer.replicate:
    class: Drupal\relaxed\Normalizer\ReplicateNormalizer
    tags:
      - { name: replication_normalizer, priority: 60 }
    arguments: ['@relaxed.replicate']
# Routing
  relaxed.api_resource.route_generator:
    class: Drupal\relaxed\Plugin\ApiResourceRouteGenerator
    arguments: ['@plugin.manager.format_negotiator', '@config.factory', '@logger.channel.relaxed']
# Subscribers
  relaxed.resource_routes:
    class: Drupal\relaxed\Routing\ApiResourceRoutes
    arguments: ['@plugin.manager.api_resource', '@relaxed.api_resource.route_generator', '@logger.channel.relaxed']
    tags:
      - { name: 'event_subscriber' }
  relaxed.sensitive_data.transformer:
    class: Drupal\relaxed\SensitiveDataTransformer
    arguments: ['@config.factory']

  replication.process_file_attachment:
    class: Drupal\relaxed\ProcessFileAttachment
    arguments: ['@current_user', '@entity_type.manager', '@multiversion.entity_index.factory']
  replication.users_mapping:
    class: Drupal\relaxed\UsersMapping
    arguments: ['@config.factory', '@entity_type.manager']

#Managers
  plugin.manager.replication_filter:
    class: Drupal\relaxed\Plugin\ReplicationFilterManager
    parent: default_plugin_manager

#Factories
  replication.changes_factory:
    class: Drupal\relaxed\ChangesFactory
    arguments: ['@multiversion.entity_index.sequence', '@entity.manager', '@replication.serializer', '@plugin.manager.replication_filter']
  replication.revisiondiff_factory:
    class: Drupal\relaxed\RevisionDiffFactory
    arguments: ['@multiversion.entity_index.rev']
  replication.bulkdocs_factory:
    class: Drupal\relaxed\BulkDocsFactory
    arguments: ['@workspaces.manager', '@multiversion.entity_index.uuid', '@multiversion.entity_index.rev','@entity_type.manager', '@lock', '@logger.factory', '@state']
  replication.alldocs_factory:
    class: Drupal\relaxed\AllDocsFactory
    arguments: ['@entity_type.manager', '@multiversion.manager', '@multiversion.entity_index.id', '@replication.serializer']

#Serializers
  replication.serializer:
    class: Symfony\Component\Serializer\Serializer
    arguments: [{  }, { }]

#Encoders
  replication.encoder.json:
    class: Drupal\serialization\Encoder\JsonEncoder
    tags:
      - { name: replication_encoder, format: json }
  replication.encoder.stream:
    class: Drupal\relaxed\Encoder\StreamEncoder
    tags:
      - { name: replication_encoder, format: stream }
  replication.encoder.base64_stream:
    class: Drupal\relaxed\Encoder\StreamEncoder
    tags:
      - { name: replication_encoder, format: base64_stream }

#Normalizers
  replication.normalizer.file_entity:
    class: Drupal\relaxed\Normalizer\FileEntityNormalizer
    arguments: ['@entity.manager', '@multiversion.entity_index.factory', '@language_manager', '@replication.users_mapping', '@module_handler', '@plugin.manager.entity_reference_selection', '@event_dispatcher', '@replication.process_file_attachment']
    tags:
      - { name: replication_normalizer, priority: 70 }
  replication.normalizer.attachment:
    class: Drupal\relaxed\Normalizer\AttachmentNormalizer
    arguments: ['@entity.manager', '@multiversion.entity_index.factory', '@language_manager', '@replication.users_mapping', '@module_handler', '@plugin.manager.entity_reference_selection', '@event_dispatcher']
    tags:
          - { name: replication_normalizer, priority: 60 }
  replication.normalizer.workspace:
    class: Drupal\relaxed\Normalizer\WorkspaceNormalizer
    arguments: ['@entity_type.manager']
    tags:
      - { name: replication_normalizer, priority: 60 }
  replication.normalizer.taxonomy_term:
    class: Drupal\relaxed\Normalizer\TaxonomyTermNormalizer
    arguments: ['@entity.manager', '@multiversion.entity_index.factory', '@language_manager', '@replication.users_mapping', '@module_handler', '@plugin.manager.entity_reference_selection', '@event_dispatcher']
    tags:
      - { name: replication_normalizer, priority: 60 }
  replication.normalizer.replication_log:
    class: Drupal\relaxed\Normalizer\ReplicationLogNormalizer
    arguments: ['@entity_type.manager', '@multiversion.entity_index.uuid']
    tags:
      - { name: replication_normalizer, priority: 60 }
  replication.normalizer.content_entity:
    class: Drupal\relaxed\Normalizer\ContentEntityNormalizer
    arguments: ['@entity.manager', '@multiversion.entity_index.factory', '@language_manager', '@replication.users_mapping', '@module_handler', '@plugin.manager.entity_reference_selection', '@event_dispatcher']
    tags:
      - { name: replication_normalizer, priority: 50 }
  replication.normalizer.bulk_docs:
    class: Drupal\relaxed\Normalizer\BulkDocsNormalizer
    tags:
      - { name: replication_normalizer, priority: 50 }
  replication.normalizer.all_docs:
    class: Drupal\relaxed\Normalizer\AllDocsNormalizer
    arguments: ['@entity.manager', '@multiversion.entity_index.uuid']
    tags:
      - { name: replication_normalizer, priority: 50 }
  replication.normalizer.changes:
    class: Drupal\relaxed\Normalizer\ChangesNormalizer
    tags:
      - { name: replication_normalizer }
    arguments: ['@entity.manager']
  replication.normalizer.revs_diff:
    class: Drupal\relaxed\Normalizer\RevsDiffNormalizer
    arguments: ['@replication.revisiondiff_factory']
    tags:
      - { name: replication_normalizer, priority: 50 }
  replication.normalizer.link_item:
    class: Drupal\relaxed\Normalizer\LinkItemNormalizer
    arguments: ['@entity_type.manager', '@plugin.manager.entity_reference_selection']
    tags:
      - { name: replication_normalizer, priority: 40 }
  replication.normalizer.text_item:
    class: Drupal\relaxed\Normalizer\TextItemNormalizer
    tags:
      - { name: replication_normalizer, priority: 30 }
  replication.normalizer.deleted_flag_item_list:
    class: Drupal\relaxed\Normalizer\DeletedFlagItemListNormalizer
    tags:
      - { name: replication_normalizer, priority: 30 }
  replication.normalizer.revision_info_item_list:
    class: Drupal\relaxed\Normalizer\RevisionInfoItemListNormalizer
    tags:
      - { name: replication_normalizer, priority: 30 }
  replication.normalizer.paragraph:
    class: Drupal\relaxed\Normalizer\ParagraphNormalizer
    arguments: ['@entity.manager', '@multiversion.entity_index.factory', '@language_manager', '@replication.users_mapping', '@module_handler', '@plugin.manager.entity_reference_selection', '@event_dispatcher']
    tags:
      - { name: normalizer, priority: 60 }
  replication.normalizer.entity_reference_item:
    class: Drupal\relaxed\Normalizer\EntityReferenceItemNormalizer
    tags:
      - { name: replication_normalizer, priority: 30 }
  replication.normalizer.comment_item:
    class: Drupal\relaxed\Normalizer\CommentItemNormalizer
    tags:
      - { name: replication_normalizer, priority: 30 }
  replication.normalizer.entity_reference_quantity_item:
    class: Drupal\relaxed\Normalizer\EntityReferenceQuantityItemNormalizer
    tags:
    - { name: normalizer, priority: 60 }

#Core Normalizers
  replication.normalizer.timestamp_item:
    class: Drupal\serialization\Normalizer\TimestampItemNormalizer
    tags:
      - { name: replication_normalizer, priority: 20 }
  replication.normalizer.complex_data:
    class: Drupal\serialization\Normalizer\ComplexDataNormalizer
    tags:
      - { name: replication_normalizer }
  replication.normalizer.field_item:
    class: Drupal\serialization\Normalizer\FieldItemNormalizer
    tags:
      - { name: replication_normalizer, priority: 10 }
  replication.normalizer.field:
    class: Drupal\serialization\Normalizer\FieldNormalizer
    tags:
      - { name: replication_normalizer, priority: 10 }
  replication.normalizer.list:
    class: Drupal\serialization\Normalizer\ListNormalizer
    tags:
      - { name: replication_normalizer, priority: 20 }
  replication.normalizer.password_field_item:
      class: Drupal\serialization\Normalizer\NullNormalizer
      arguments: ['Drupal\Core\Field\Plugin\Field\FieldType\PasswordItem']
      tags:
        - { name: replication_normalizer, priority: 100 }
  replication.normalizer.safe_string:
      class: Drupal\serialization\Normalizer\MarkupNormalizer
      tags:
        - { name: replication_normalizer }
  replication.normalizer.primitive_data:
    class: Drupal\serialization\Normalizer\PrimitiveDataNormalizer
    tags:
      - { name: replication_normalizer, priority: 10 }
  replication.normalizer.typed_data:
    class: Drupal\serialization\Normalizer\TypedDataNormalizer
    tags:
      - { name: replication_normalizer }